const perricosArray = []; // Este array contendr치 los objetos con {image: 'url', breed: 'raza'}
console.log(perricosArray);
const select = document.querySelector("#breeds-picker"); //selecciona el desplegable donde elegir las razas
let selectedBreed = ''; //aqu칤 guardaremos la raza seleccionada en el select
let filteredPerricos; //array de objetos con los perros de la raza que se quiere filtrar
let breedCounters = {}; // objeto que guardar치 los contadores de cada raza de perros
let activeFilters = []; //array que almacna m칰ltipls razas seleccionadas para poder filtrarlas luego
console.log(activeFilters);

const timeoutId = setTimeout(() => {
  document.querySelector('#add-warning').style.display = '';
}, 3000);

const breedsPicker = document.querySelector("#breeds-picker");
let breedNamesArray = [];

//addEventListener para detectar el CAMBIO DE RAZA y actualizar la raza selccionada
breedsPicker.addEventListener('change', (event)=>{ //funci칩n an칩nima que se ejecuta cuando el valor de un elemento del selct cambia.
  selectedBreed = event.target.value; //event.target se refiere al elemento que dispar칩 el evento y value es el valor del elemento targeteado
  console.log('Filtrando por raza: ', selectedBreed) //vemos si se actualiza
}) //una vez cambiada la raza usaremos esta variable para pasarsela a getRandomDogImage

window.onload = async()=>{
  const dogBreeds = await getDogBreeds(); //esto es el objeto de razas de perros

for (let breed in dogBreeds){
    if(dogBreeds[breed].length === 0){
      breedNamesArray.push(breed);
      let option = document.createElement("option");
      option.value = breed;
      option.textContent = breed;
      select.appendChild(option); //appendChild coloca los nuevos elementos al final del elemento padre
    } else {
      let optgroup = document.createElement("optgroup"); //crae el contenedor optgroup con label breed y valu breed
      optgroup.label = breed; //aparecr치 el nombre de la raza principal en la ventana desplegable
      optgroup.value = breed; //lo mismo para el atributo value

      //dentro del forEach metermos cada option que tenga la raza en concreto
      dogBreeds[breed].forEach((breedSurname)=>{

        const breedFullName = `${breedSurname}--${breed}`;
        breedNamesArray.push(`${breedSurname} ${breed}`);
        let option = document.createElement("option"); //crea un elmento option con value breedFullName
        option.value = breedFullName;
        option.textContent = `${breedSurname} ${breed}`;
        optgroup.appendChild(option); //se a침ade la etiqueta option a optgroup
      });
      select.appendChild(optgroup); //una vez a침adidas todas las subrazas al padre optgroup, este se a침ad al padre "select"
    }
}

console.log(breedNamesArray); 
};

// funci칩n para ocultar el mensaje de advertencia, borra el set time out si a칰n no ha aparecido el mensaje y si ya ha aparecido lo oculta
function clearWarningMessage() {
  clearTimeout(timeoutId);
  document.querySelector('#add-warning').style.display = 'none';
}

//funci칩n que gestiona likes y dislikes, a침ade a cada bot칩n un evento: cuando se clicka se el suma 1 al contador
//add social listeners solo selecciona los botones que ya existen en el DOM cuando se ejecuta, necesitamos a침adir las funcionalidads de like y dislike a addPerrico
function addSocialListeners() {
  document.querySelectorAll('.like').forEach((buttonNode) => { //selecciona todos los botones de like y los recorre
    buttonNode.addEventListener('click', function () { //a침ade un listener
      const hermanico = buttonNode.previousElementSibling; // = etiqueta <p> con los contadores
      const likeCountNode = hermanico.querySelector('.like-count') //busca el span con la clase .like-count;
      const perricoData = getPerricoDataFromNode(buttonNode);  // Funci칩n para obtener el objeto perricoData
      perricoData.likes += 1;  // Incrementa el contador de likes en el objeto dentro de perricosArray
      likeCountNode.innerText = perricoData.likes;  // Actualiza el contador en el DOM dentro de la etiqueta span
    });
  });

  document.querySelectorAll('.dislike').forEach((buttonNode) => {
    buttonNode.addEventListener('click', function () {
      console.log(buttonNode.closest('.card'));
      const likeCountNode = buttonNode.closest('.card').querySelector('.dislike-count');
      const perricoData = getPerricoDataFromNode(buttonNode);  // Funci칩n para obtener el objeto perricoData
      perricoData.dislikes += 1;  // Incrementa el contador de dislikes
      likeCountNode.innerText = perricoData.dislikes;  // Actualiza el contador en el DOM
    });
  });
};

// Funci칩n para obtener el objeto perricoData asociado con una tarjeta, encuentra el valor de like y dislike para actualizarlos
function getPerricoDataFromNode(buttonNode) { //recibe como par치metro el bot칩n de like o dislike que el usuario ha presionado
  const card = buttonNode.closest('.card'); // Encuentra el elemento m치s cercano con la clase 'card'
  const image = card.querySelector('img').src;  // Obtiene la URL de la imagen del perro (que es 칰nica para cada perrico)
  return perricosArray.find(perrico => perrico.image === image);  // Busca el perricoData en el array perricosArray usando la imagen como clave
}

//funci칩n que renderiza el array de perritos, limpia la lista de perros antes de renderizarla y llama a addSocialListeners para habilitar los eventos
function renderPerricoArray() {
  const dogList = document.querySelector('#dog-list');
  dogList.innerHTML = '';

  perricosArray.forEach((perricoData) => { //como ahora es un objeto cambiamos dogImage por perricoData.image
    const htmlAdd = `<div class="card">
  <img src="${perricoData.image}" alt="Perro" />
  <br />
  <p><span class="like-count">${perricoData.likes}</span>仇벒잺 <span class="dislike-count">${perricoData.dislikes}</span>游뱙</p>
  <button class="like">Precios칤simo</button> <button class="dislike">Fe칤sisimo</button>
</div>`;

    dogList.innerHTML += htmlAdd;
  });

  addSocialListeners();
};

//funciones que deshabilitan los botones hasta quee se carguen las cartas de perros
function disableAllAddPerricoButtons() { //deshabilita todos los botones de a침adir perritos, esto es para que se deshabiliten hasta que se carguen todas las im치genes
  document.querySelectorAll('.add-button').forEach((buttonNode) => {
    buttonNode.disabled = true;
  });
}

function enableAllAddPerricoButtons() {
  document.querySelectorAll('.add-button').forEach((buttonNode) => {
    buttonNode.disabled = false;
  });
}


//funci칩n para filtrar los Perros seg칰n la raza: genera un nuevo array con la raza seleccionada y llama a renderFilterdPerricos pas치ndole el nuevo array
const filterByBreed = () =>{
  if (activeFilters.length === 0){ //si en el array de filtrado no hay razas, no hay filtros activados, muestra todos los perros
    renderPerricoArray(); //se renderizan todos los perros
    return;
  }
//filterdPerricos es una variable que almacena los objetos de las razas de perro a filtrar. En este caso obtendr치 los perros cuya raza est치n en el array activeFilters
//filtra solo los perros que coinicdadn con alguna de las razas activas 
filteredPerricos = perricosArray.filter(perrico => activeFilters.includes(perrico.breed));
  renderFilteredPerricos(filteredPerricos);
};


//funci칩n que renderiza los perritos filtrados por raza
const renderFilteredPerricos = (filteredPerricos) =>{ // a esta funci칩n se le pasa
  const dogList = document.querySelector("#dog-list");
  dogList.innerHTML = ""; // Limpia la lista antes de renderizar

  filteredPerricos.forEach((perricoData) => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img src="${perricoData.image}" alt="Perro" />
      <br />
      <p>
        <span class="like-count">${perricoData.likes}</span>仇벒잺 
        <span class="dislike-count">${perricoData.dislikes}</span>游뱙
      </p>
      <button class="like">Precios칤simo</button> 
      <button class="dislike">Fe칤sisimo</button>`;

    dogList.appendChild(card);
  });

  addSocialListeners(); // Aseg칰rate de volver a a침adir los listeners de like/dislike
};


 //funci칩n as칤ncrona que a침ade un perrito, obtioene un perrico al alzar con getRandomDogImage, a침ade al principio o al final y crea un div con la im치gen y los botones

//todo el manejo de razas, contadores y botones de filtro se ejecuta cuando se agrega un perro.
// Esto mantiene el flujo del c칩digo m치s claro y organizado, y asegura que los elementos del DOM 
// (como los botones de raza y los contadores) se manejen correctamente en el momento exacto en que se agregan nuevos perros,
// evitando errores de sincronizaci칩n.
const addPerrico = async (addToStart) => {
    // const breed = document.querySelector('[name=breeds]').value; //selecciona el valor del select
    let breed = selectedBreed; //raza de perro seleccionada
    
    // Si no hay raza seleccionada, obtenemos una imagen aleatoria y detectamos su raza
    const perricoImg = await getRandomDogImage(breed); //desde aqu칤 llamamos a la funci칩n getRandomDogImage del archivo js api
//si selectedBreed est치 vac칤o ('') como dice en el archivo api.js, se pasar치 un link de foto de perro aleatorio
  if (!breed) {
    breed = extractBreedFromImage(perricoImg); // Detectar la raza desde la URL de la imagen y a침adirla a la variable breed
  }

//creamos un objeto con la im치gen y la raza
const perricoData = {
  image: perricoImg,
  breed: breed,
  likes: 0, //contador de likes
  dislikes: 0 //contador de dislikes
};

 // Aqu칤 es donde insertamos el bloque que maneja el contador de razas
  if (!breedCounters[breed]) {
    breedCounters[breed] = 1; // Iniciar el contador en 1 para esta raza
    createBreedFilterButton(breed); // Crear el bot칩n si no existe

  // Asegurarnos de que el bot칩n se cre칩 antes de actualizar el contador
  setTimeout(() => {
      updateBreedCounter(breed); // Actualiza el contador con el valor actual
  }, 50); // Le damos un peque침o margen de tiempo
  } else {
    breedCounters[breed]++; // Si la raza ya existe, incrementamos el contador
    updateBreedCounter(breed); // Actualizar el contador de la raza
}


 // Para a침adir el objeto perro al array, al principio o al final dependiendo de addToStart
  if (addToStart) {
    perricosArray.unshift(perricoData);
  } else {
    perricosArray.push(perricoData);
  }


  const dogList = document.querySelector('#dog-list');

  const isAnyFilterSelected = document.querySelector('.filter-selected');

  const perricoCardElement = document.createElement('div');
  perricoCardElement.className = 'card';
  perricoCardElement.style.display = isAnyFilterSelected ? 'none' : '';

  perricoCardElement.innerHTML = `
  <img src="${perricoData.image}" alt="Perro" />
  <br />
  <p><span class="like-count">${perricoData.likes}</span>仇벒잺 <span class="dislike-count">${perricoData.dislikes}</span>游뱙</p>
  <button class="like">Precios칤simo</button> <button class="dislike">Fe칤sisimo</button>`;

  if (addToStart) {
    dogList.prepend(perricoCardElement);
  } else {
    dogList.appendChild(perricoCardElement);
  }

  const likeButton = perricoCardElement.querySelector('.like');

  likeButton.addEventListener('click', function () {
    perricoData.likes++;
    const likeCountNode = perricoCardElement.querySelector('.like-count');
    likeCountNode.innerText = perricoData.likes;
  });

  const dislikeButton = perricoCardElement.querySelector('.dislike');
  dislikeButton.addEventListener('click', function () {
    perricoData.dislikes++;
    const likeCountNode = perricoCardElement.querySelector('.dislike-count');
    likeCountNode.innerText = perricoData.dislikes;
  });

  //llamamos a la funci칩n que actualiza el contado de la raza
  updateBreedCounter(breed);
};

//funci칩n que extrae la raza desde la url de la im치gen para poder detectarla
const extractBreedFromImage = (imageUrl) => {
  const regex = /breeds\/([^\/]+)\//; // Extrae el nombre de la raza de la URL
  const match = imageUrl.match(regex);
  
  if (match && match[1]) {
      let breed = match[1].replace("-", "--"); // Formatear raza correctamente
      return breed;
  }
  return "Desconocida"; // Si no se puede extraer, devolver "Desconocida"
};


//funci칩n que se encarga de actualizar los contadores de razas de perritos, si la raza a칰n no tiene un bot칩n, crealo, si ya lo tiene incrementa el contador
const updateBreedCounter = (breed) =>{
  const counterElement = document.querySelector(`#counter-${breed}`);
    if (counterElement) {
        counterElement.innerHTML = breedCounters[breed];
    } else {
        console.warn(`No se encontr칩 el contador para la raza: ${breed}`);
    }
}

//funci칩n que crea el bot칩n de la raza si no ha sido creada previamente
const createBreedFilterButton = (breed) => {
  const filterContainer = document.querySelector('.filters'); //selecciona el contenedor de los filstros, de inicio tiene ya los botones de like y dislike
  let button = document.querySelector(`#filter-${breed}`); // busca si ya existe el bot칩n, si no existe dar치 null

  if(!button){ //si tiene valor falsy (null, 0, undefined, false, '', NaN)
    button = document.createElement('button');
    button.id = `filter-${breed}`;
    button.innerHTML = `${breed} (<span id="counter-${breed}">1</span>)`; 
    button.addEventListener('click', ()=> 
      toggleBreedFilter(breed, button)); //llama a la funci칩n toggleBreedFilter
    filterContainer.appendChild(button); //a침ade dentro del div el bot칩n
    console.log(`Bot칩n creado para: ${breed}`); //indica en consola si se ha creado el bot칩n con la raza
  }
};



//funci칩n que filtra por razas, modifica el array activeFiltrs para saber cualse tiene que filtrar
const toggleBreedFilter = (breed, button) =>{
  if(activeFilters.includes(breed)){
    //si la raza ya est치 activa, la eliminamos del array 
    activeFilters = activeFilters.filter(activeBreed => activeBreed !== breed);
    button.classList.remove('active-filter'); //quita el estilo de filtro activo
    renderPerricoArray(); //muestra todos los perros nuevamente
  } else {
    //si la raza no est치 activa, la agregamos al array
    activeFilters.push(breed); //si no est치 activa se pushea dentro del array de razas a filtrar
    button.classList.add('active-filter');
  }
  filterByBreed(); //se usa filtrByBreed para actualizar la lista de perros
}

//definici칩n de eventos para los botones

/* document.querySelector('#filter-button').addEventListener('click', function () {
  filterByBreed(); // Llamamos a la funci칩n de filtro cuando se hace clic
}); */

document.querySelector('#add-1-perrico').addEventListener('click', async function () { //debe ser asincrona la funci칩n porque necesitamos un await, esto funciona porque addPerrico() tambi칠n es as칤ncrona
  clearWarningMessage();
//igual para todos los botones, debemos a침adir un await antes de volver a activar el bot칩n
  disableAllAddPerricoButtons(); //al clickar el bot칩n de a침adir 1 perrito que se deshabiliten todos los botones
  await addPerrico(); //que llame a addPerrico
  enableAllAddPerricoButtons(); //que vuelva a habilitar los botones despu칠s de que addPerrico se haya ejecutado y haya emitido una respuesta
});

document.querySelector('#add-1-perrico-start').addEventListener('click', async function () {
  clearWarningMessage();

  disableAllAddPerricoButtons();
  await addPerrico(true);
  enableAllAddPerricoButtons();
});

document.querySelector('#add-5-perricos').addEventListener('click', async function () {
  clearWarningMessage();

  disableAllAddPerricoButtons();
  await Promise.all([addPerrico(), addPerrico(), addPerrico(), addPerrico(), addPerrico()]); //esto hace que se ejecuten todas las llamadas a la funci칩n a la vez, y que no siga l c칩digo hasta que todas se ejecuten
  enableAllAddPerricoButtons();
});

const likeFilterButton = document.querySelector('#like-filter');

likeFilterButton.addEventListener('click', function () {
  likeFilterButton.classList.toggle('filter-selected');
  filterPerricos();
});

const dislikeFilter = document.querySelector('#dislike-filter');

dislikeFilter.addEventListener('click', function () {
  dislikeFilter.classList.toggle('filter-selected');
  filterPerricos();
});

//funci칩n que filtra por likes y dislikes: (no funcionaba porque antes por default innerText era '' hasta que se votaba, sin mbargo ahora es '0', y antes lo que hac칤a era filtrar seg칰n si ten칤a o no texto, pero ahora tine texto siempre)
function filterPerricos() {
  const isLikeFilterSelected = likeFilterButton.classList.contains('filter-selected'); //Comprueba si los botones de filtro (likeFilterButton y dislikeFilter) tienen la clase filter-selected, lo que indica si el usuario activ칩 el filtro de "like" o "dislike".
  const isDislikeSelected = dislikeFilter.classList.contains('filter-selected');
  
  console.log('filtering', { //Esto imprime en la consola del navegador un objeto con los estados de los filtros, por ejemplo: filtering { isLikeFilterSelected: true, isDislikeSelected: false }
    isLikeFilterSelected,
    isDislikeSelected
  });

  document.querySelectorAll('.card').forEach((perricoNode) => { //Usa .forEach() para recorrer cada una y decidir si debe mostrarse o esconderse.
    // si no hay ning칰n filtro aplicado, los muestra todos
    if (!isLikeFilterSelected && !isDislikeSelected) {
      perricoNode.style.display = '';
      return;
    }
    // si preciosismo aplicado y hay preciosisimo lo muestra (no funcionaba porque antes por default innerText era '' hasta que se votaba, sin mbargo ahora es '0')
    const likeCount = parseInt(perricoNode.querySelector('.like-count').innerText, 10); // Convierte el valor de los likes a n칰mero
    if (likeCount > 0 && isLikeFilterSelected) {
      perricoNode.style.display = ''; // Muestra el perro si tiene al menos 1 like
      return;
    }

    // si fe칤simo aplicado y hay fe칤simo lo muestra
    const dislikeCount = parseInt(perricoNode.querySelector('.dislike-count').innerText, 10); // Convierte el valor de los dislikes a n칰mero
    if (dislikeCount > 0 && isDislikeSelected) {
      perricoNode.style.display = '';
      return;
    }

    perricoNode.style.display = 'none';  // Si no cumple con ning칰n filtro, lo oculta
  });
}

document.querySelector('#dislike-filter').addEventListener('click', function () {
  console.log('dislike filter clicked');
});

renderPerricoArray();

// let automaticPerrosCount = 0;
// const intervalId = setInterval(() => {
//   addPerrico();
//   automaticPerrosCount++;

//   if (automaticPerrosCount === 2) {
//     clearInterval(intervalId);
//   }
// }, 1000);